{% extends 'admin_dashboard.html' %}

{% block title %}Registrar Rúbrica{% endblock %}

{% block content %}
<ul class="breadcrumb mb-3">
    <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Inicio</a></li>
    <li class="breadcrumb-item"><a href="{% url 'list_rubricas' %}">Rúbricas</a></li>
    <li class="breadcrumb-item active" aria-current="page">Registrar</li>
</ul>

<div class="container mt-5">
    <h2 class="text-center">Registrar Nueva Rúbrica</h2>
    <form method="POST" id="formAddRubrica" autocomplete="off" novalidate>
        {% csrf_token %}
        <div class="row">
            <div class="mb-3 col-md-4">
                <label for="tipo_eval" class="form-label">Tipo de Evaluación <span class="text-danger">*</span></label>
                <select name="tipo_eval" id="tipo_eval" class="form-select" required>
                    <option value="">Seleccionar</option>
                    {% for t in tipos %}
                        <option value="{{ t.id_tip }}">{{ t.nombre_tip }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3 col-md-4">
                <label for="fk_id_prm" class="form-label">Parámetro <span class="text-danger">*</span></label>
                <select name="fk_id_prm" id="fk_id_prm" class="form-select" required>
                    <option value="">Seleccionar primero tipo de evaluación</option>
                    <!-- Opciones AJAX -->
                </select>
            </div>
            <div class="mb-3 col-md-4">
                <label for="fk_id_cat" class="form-label">Categoría <span class="text-danger">*</span></label>
                <select name="fk_id_cat" id="fk_id_cat" class="form-select" required>
                    <option value="">Seleccionar</option>
                    {% for cat in categorias %}
                    <option value="{{ cat.id_cat }}">{{ cat.nombre_cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3 col-md-4">
                <label for="fk_id_unes" class="form-label">Unidad <span class="text-danger">*</span></label>
                <select name="fk_id_unes" id="fk_id_unes" class="form-select" required>
                    <option value="">Seleccionar</option>
                    {% for unes in unidades %}
                    <option value="{{ unes.id_unes }}" data-unidad="{{ unes.nombre_unes }}">{{ unes.nombre_unes }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <hr>
        <h5 class="text-center">Escalas de la Rúbrica</h5>
        <div class="table-responsive">
            <table class="table table-bordered align-middle" id="tablaRubrica">
                <thead class="table-light text-center">
                    <tr>
                        <th>Valor Mínimo</th>
                        <th></th>
                        <th>Valor Máximo</th>
                        <th>Puntaje</th>
                    </tr>
                </thead>
                <tbody id="tbodyRubrica">
                    <tr>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_min_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td class="text-center">Hasta</td>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_max_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td>
                            <input type="number" step="0.01" min="0" max="10" name="puntaje_rub[]" class="form-control" required value="10.00" hidden>
                            <span>10.00</span> <!-- Muestra el valor predeterminado al usuario -->
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_min_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td class="text-center">Hasta</td>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_max_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td>
                            <input type="number" step="0.01" min="0" max="10" name="puntaje_rub[]" class="form-control" required value="9.00" hidden>
                            <span>9.00</span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_min_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td class="text-center">Hasta</td>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_max_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td>
                            <input type="number" step="0.01" min="0" max="10" name="puntaje_rub[]" class="form-control" required value="8.00" hidden>
                            <span>8.00</span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_min_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td class="text-center">Hasta</td>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_max_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td>
                            <input type="number" step="0.01" min="0" max="10" name="puntaje_rub[]" class="form-control" required value="7.00" hidden>
                            <span>7.00</span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_min_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td class="text-center">Hasta</td>
                        <td>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" name="valor_max_rub[]" class="form-control" required>
                                <span class="input-group-text unit-span"></span>
                            </div>
                        </td>
                        <td>
                            <input type="number" step="0.01" min="0" max="10" name="puntaje_rub[]" class="form-control" required value="6.00" hidden>
                            <span>6.00</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="text-center mt-3">
            <button type="submit" class="btn btn-success me-2">
                <i class="bi bi-check-lg me-1"></i>Registrar
            </button>
            <a href="{% url 'list_rubricas' %}" class="btn btn-secondary">
                <i class="bi bi-x-lg me-1"></i>Cancelar
            </a>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // AJAX para cargar los parámetros dependiendo del tipo de evaluación
    $('#tipo_eval').on('change', function() {
        let tipoId = $(this).val();
        $('#fk_id_prm').html('<option value="">Cargando...</option>');
        
        if(tipoId) {
            $.get("{% url 'ajax_parametros_por_tipo' %}", { tipo_id: tipoId }, function(response) {
                let options = '<option value="">Seleccionar</option>';
                response.parametros.forEach(function(parametro) {
                    options += `<option value="${parametro.id_prm}">${parametro.nombre_prm}</option>`;
                });
                $('#fk_id_prm').html(options);
            });
        } else {
            $('#fk_id_prm').html('<option value="">Seleccionar primero tipo de evaluación</option>');
        }
    });

    // Detectar la unidad seleccionada y mostrarla en las filas
    $('#fk_id_unes').on('change', function() {
        let unidad = $(this).find(':selected').data('unidad');
        $('.unit-span').text(unidad);
    });
</script>

{% endblock %}

<style>
    .input-group {
        display: flex;
        align-items: center;
    }

    .input-group .form-control {
        flex-grow: 1;
    }

    .input-group .input-group-text {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
    }
</style>
